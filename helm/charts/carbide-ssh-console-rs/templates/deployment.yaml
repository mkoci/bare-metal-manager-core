apiVersion: apps/v1
kind: Deployment
metadata:
  name: carbide-ssh-console-rs
  namespace: {{ include "carbide-ssh-console-rs.namespace" . }}
  labels:
    {{- include "carbide-ssh-console-rs.labels" . | nindent 4 }}
  annotations:
    {{- toYaml .Values.annotations | nindent 4 }}
spec:
  replicas: {{ .Values.replicas }}
  strategy:
    type: Recreate
  selector:
    matchLabels:
      {{- include "carbide-ssh-console-rs.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "carbide-ssh-console-rs.labels" . | nindent 8 }}
    spec:
      serviceAccountName: carbide-ssh-console-rs
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: ssh-console-rs
          image: "{{ include "carbide-ssh-console-rs.image" . }}"
          command: ["/opt/carbide/ssh-console"]
          args: ["run", "-c", "/etc/forge/ssh-console/config.toml"]
          imagePullPolicy: {{ .Values.global.image.pullPolicy }}
          securityContext:
            capabilities:
              add:
                - IPC_LOCK
          ports:
            - name: ssh
              containerPort: {{ .Values.service.port }}
              protocol: TCP
          readinessProbe:
            {{- toYaml .Values.readinessProbe | nindent 12 }}
          resources: {}
          volumeMounts:
            - name: ssh-console-rs-config-files
              mountPath: /etc/forge/ssh-console
            - name: spiffe
              mountPath: "/var/run/secrets/spiffe.io"
              readOnly: true
            - name: ssh-host-key
              mountPath: /etc/ssh/ssh_host_ed25519_key
              subPath: ssh_host_ed25519_key
              readOnly: true
            - name: ssh-host-key-pub
              mountPath: /etc/ssh/ssh_host_ed25519_key.pub
              subPath: ssh_host_ed25519_key_pub
              readOnly: true
            - name: console-logs
              mountPath: /var/log/consoles
        - name: loki-log-collector
          image: "{{ .Values.lokiLogCollector.image.repository }}:{{ .Values.lokiLogCollector.image.tag }}"
          imagePullPolicy: {{ .Values.global.image.pullPolicy }}
          args: ["--config=/etc/otelcol-contrib/config.yaml"]
          volumeMounts:
            - name: otelcol-config
              mountPath: /etc/otelcol-contrib
              readOnly: true
            - name: console-logs
              mountPath: /var/log/consoles
            - name: otelcol-file-log-checkpoints
              mountPath: /var/lib/otelcol/filelog-checkpoints
      volumes:
        - name: ssh-console-rs-config-files
          configMap:
            name: ssh-console-rs-config-files
        - name: spiffe
          secret:
            secretName: carbide-ssh-console-rs-certificate
        - name: ssh-host-key
          secret:
            secretName: ssh-host-key
            defaultMode: 0400
        - name: ssh-host-key-pub
          secret:
            secretName: ssh-host-key
            defaultMode: 0444
        - name: console-logs
          emptyDir: {}
        - name: otelcol-file-log-checkpoints
          emptyDir: {}
        - name: otelcol-config
          configMap:
            name: ssh-console-rs-otelcol-config
